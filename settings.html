<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Dictionary Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <style>
        .form-floating {
            margin-bottom: 1rem;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            z-index: 1050;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Dictionary Settings</h1>

        <div class="row">
            <div class="col-md-8 col-lg-6">
                <form id="settingsForm">
                    <div class="form-floating">
                        <input type="password" class="form-control" id="apiKey" placeholder="API Key">
                        <label for="apiKey">OpenAI API Key</label>
                    </div>

                    <div class="form-floating">
                        <input type="url" class="form-control" id="endpoint" placeholder="API Endpoint">
                        <label for="endpoint">OpenAI API Endpoint</label>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" class="btn btn-secondary ms-2" id="testConnection">Test
                            Connection</button>
                        <a href="dictionary.html" class="btn btn-outline-primary ms-2">Go to Dictionary</a>
                    </div>
                </form>

                <div class="mt-4">
                    <h5>Current Settings:</h5>
                    <pre id="currentSettings" class="bg-light p-3 rounded"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert for notifications -->
    <div class="alert" role="alert"></div>

    <script>
        const hostname = 'paweladamczuk.com';
        const groupId = 'OpenAiEndpoint';
        const settingsPrefix = `${hostname}.${groupId}`;

        // Function to show notification
        function showNotification(message, type = 'success') {
            const alert = document.querySelector('.alert');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alert.style.display = 'block';

            // Auto-hide after 3 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // Function to load and display current settings
        function displayCurrentSettings() {
            const settings = {
                apiKey: localStorage.getItem(`${settingsPrefix}.apiKey`),
                endpoint: localStorage.getItem(`${settingsPrefix}.endpoint`)
            };

            // Show masked API key if it exists
            if (settings.apiKey) {
                settings.apiKey = '*'.repeat(settings.apiKey.length);
            }

            document.getElementById('currentSettings').textContent =
                JSON.stringify(settings, null, 2);

            // Pre-fill the form if settings exist
            if (settings.endpoint) {
                document.getElementById('endpoint').value = settings.endpoint;
            }
        }

        // Handle form submission
        document.getElementById('settingsForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const apiKey = document.getElementById('apiKey').value.trim();
            const endpoint = document.getElementById('endpoint').value.trim();

            if (apiKey) {
                localStorage.setItem(`${settingsPrefix}.apiKey`, apiKey);
            }
            if (endpoint) {
                localStorage.setItem(`${settingsPrefix}.endpoint`, endpoint);
            }

            showNotification('Settings saved successfully!');
            displayCurrentSettings();

            // Clear the API key field for security
            document.getElementById('apiKey').value = '';
        });

        // Test connection
        document.getElementById('testConnection').addEventListener('click', async function () {
            const apiKey = localStorage.getItem(`${settingsPrefix}.apiKey`);
            const endpoint = localStorage.getItem(`${settingsPrefix}.endpoint`);

            if (!apiKey || !endpoint) {
                showNotification('Please save your API settings first', 'warning');
                return;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            { role: 'user', content: 'Say "Connection successful!"' }
                        ],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    showNotification('Connection test successful!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(`Connection test failed: ${error.error?.message || 'Unknown error'}`, 'danger');
                }
            } catch (error) {
                showNotification(`Connection test failed: ${error.message}`, 'danger');
            }
        });

        // Load current settings on page load
        displayCurrentSettings();
    </script>
</body>

</html>