<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dictionary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .response-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: clamp(15px, 3vw, 20px);
            margin-top: clamp(15px, 3vw, 20px);
            font-size: clamp(1em, 2.5vw, 1.1em);
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        @media (max-width: 576px) {
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
        }

        /* Markdown styling */
        .response-box h1 {
            font-size: 1.8em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .response-box h2 {
            font-size: 1.5em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .response-box h3 {
            font-size: 1.3em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .response-box p {
            margin-bottom: 1em;
        }

        .response-box ul,
        .response-box ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .response-box code {
            background-color: #eee;
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        .response-box pre {
            background-color: #eee;
            padding: clamp(0.5em, 2vw, 1em);
            border-radius: 5px;
            overflow-x: auto;
            max-width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .response-box blockquote {
            border-left: 4px solid #ccc;
            margin: 1em 0;
            padding-left: 1em;
            color: #666;
        }

        #searchInput {
            font-size: clamp(1.2em, 4vw, 1.5em);
            padding: clamp(10px, 2vw, 15px);
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .hidden {
            display: none;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            margin: 2rem auto;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fade-in 0.3s ease-in;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div id="configError" class="row justify-content-center hidden">
            <div class="col-12">
                <div class="alert alert-warning text-center" role="alert">
                    <h4 class="alert-heading mb-3">Configuration Required</h4>
                    <p>The dictionary needs to be configured before it can be used.</p>
                    <hr>
                    <a href="settings.html" class="btn btn-warning">Go to Settings</a>
                </div>
            </div>
        </div>
        <div id="searchContainer" class="row justify-content-center">
            <div class="col-12">
                <input type="text" id="searchInput" class="form-control form-control-lg"
                    placeholder="Type a word and press Enter..." autocomplete="off" autofocus>
            </div>
        </div>
        <div id="responseContainer" class="row justify-content-center hidden">
            <div class="col-12">
                <div id="responseBox" class="response-box">
                    <div id="spinner" class="spinner hidden">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="responseText"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to focus input and open keyboard
        function focusAndOpenKeyboard() {
            const searchInput = document.getElementById('searchInput');

            // Special handling for iOS Safari
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                // Create a temporary button and click it to enable user interaction
                const tempButton = document.createElement('button');
                tempButton.style.position = 'fixed';
                tempButton.style.top = '0';
                tempButton.style.left = '0';
                tempButton.style.opacity = '0';
                document.body.appendChild(tempButton);

                tempButton.addEventListener('click', function () {
                    searchInput.focus();
                    // Add a slight delay for iOS
                    setTimeout(() => {
                        searchInput.click();
                        // Remove the temporary button
                        document.body.removeChild(tempButton);
                    }, 100);
                });

                tempButton.click();
            } else {
                searchInput.focus();
                // For Android
                if (/Android/.test(navigator.userAgent)) {
                    searchInput.blur();
                    searchInput.focus();
                }
            }
        }

        // Focus input when page loads and after a small delay
        document.addEventListener('DOMContentLoaded', () => {
            // Small delay to ensure DOM is fully ready
            setTimeout(focusAndOpenKeyboard, 300);
        });

        // Also focus when visibility changes (e.g., when user switches back to the tab)
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                setTimeout(focusAndOpenKeyboard, 300);
            }
        });

        // Check URL parameters and save to localStorage if present
        function saveConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            const endpoint = urlParams.get('endpoint');

            if (key && endpoint) {
                const hostname = 'paweladamczuk.com';
                const groupId = 'OpenAiEndpoint';
                localStorage.setItem(`${hostname}.${groupId}.apiKey`, key);
                localStorage.setItem(`${hostname}.${groupId}.endpoint`, endpoint);

                // Remove parameters from URL without reloading
                window.history.replaceState({}, document.title, window.location.pathname);
                return true;
            }
            return false;
        }

        // Try to save config from URL and reload if successful
        if (saveConfigFromUrl()) {
            location.reload();
        }

        // Load system prompt
        let systemPrompt;
        fetch('assets/dictionary-prompt.txt')
            .then(response => response.text())
            .then(text => {
                systemPrompt = text;
            })
            .catch(error => console.error('Error loading system prompt:', error));

        // Get DOM elements first
        const configError = document.getElementById('configError');
        const searchContainer = document.getElementById('searchContainer');
        const responseContainer = document.getElementById('responseContainer');
        const searchInput = document.getElementById('searchInput');
        const responseBox = document.getElementById('responseBox');
        const spinner = document.getElementById('spinner');
        const responseText = document.getElementById('responseText');

        // Get API configuration from LocalStorage
        const hostname = 'paweladamczuk.com';
        const groupId = 'OpenAiEndpoint';
        const apiKey = localStorage.getItem(`${hostname}.${groupId}.apiKey`);
        const apiEndpoint = localStorage.getItem(`${hostname}.${groupId}.endpoint`);

        function checkConfiguration() {
            if (!apiKey || !apiEndpoint) {
                searchContainer.classList.add('hidden');
                responseContainer.classList.add('hidden');
                configError.classList.remove('hidden');
                return false;
            }
            configError.classList.add('hidden');
            searchContainer.classList.remove('hidden');
            return true;
        }

        // Initial configuration check
        checkConfiguration();

        // Handle enter key press
        searchInput.addEventListener('keypress', async function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = searchInput.value.trim();

                if (!checkConfiguration()) {
                    return;
                }

                if (query) {
                    // Hide search, show response with spinner
                    searchContainer.classList.add('hidden');
                    responseContainer.classList.remove('hidden');
                    responseText.textContent = ''; // Clear previous response
                    spinner.classList.remove('hidden');
                    responseText.classList.add('hidden');

                    try {
                        console.log('Making request to:', apiEndpoint);
                        const response = await fetch(apiEndpoint + '/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`,
                                'HTTP-Referer': 'https://paweladamczuk.com',
                                'X-Title': 'Dictionary Assistant'
                            },
                            body: JSON.stringify({
                                model: 'meta-llama/llama-4-scout',
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: `Define and explain the word or phrase: ${query}` }
                                ],
                                temperature: 0.7
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error?.message || 'API request failed');
                        }

                        // Hide spinner and display the response with markdown
                        spinner.classList.add('hidden');
                        responseText.innerHTML = marked.parse(data.choices[0].message.content);
                        responseText.classList.remove('hidden');
                        responseText.classList.add('fade-in');

                    } catch (error) {
                        console.error('Error:', error);
                        if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                            spinner.classList.add('hidden');
                            responseText.innerHTML = '<p class="text-danger">Connection error. Please check if the API endpoint is correct and accessible.</p>';
                            responseText.classList.remove('hidden');
                        } else {
                            spinner.classList.add('hidden');
                            responseText.innerHTML = `<p class="text-danger">An error occurred while fetching the response: ${error.message}</p>`;
                            responseText.classList.remove('hidden');
                        }
                    }
                }
            }
        });

        // Double click anywhere to show search input again
        document.addEventListener('dblclick', function () {
            searchContainer.classList.remove('hidden');
            responseContainer.classList.add('hidden');
            searchInput.value = '';
            searchInput.focus();
        });
    </script>
</body>

</html>